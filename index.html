<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¢y Th√¥ng Gi√°ng Sinh T∆∞∆°ng T√°c - Xoay 360¬∞</title>
    
    <!-- Th∆∞ vi·ªán Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- MediaPipe Hands - ƒê√É ƒê∆Ø·ª¢C S·ª¨A ƒê·ªÇ T∆Ø∆†NG TH√çCH GITHUB -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            color: white;
        }
        
        #canvas-container {
            width: 100%;
            height: 100vh;
            display: block;
        }
        
        #ui-layer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 100;
        }
        
        .status-badge {
            display: inline-block;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            text-shadow: 0 0 10px #FFD700;
            backdrop-filter: blur(5px);
        }
        
        .instructions {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px black;
            background: rgba(0, 0, 0, 0.5);
            display: inline-block;
            padding: 8px 15px;
            border-radius: 10px;
        }
        
        .start-button {
            pointer-events: auto;
            cursor: pointer;
            background: linear-gradient(to bottom, #D32F2F, #8B0000);
            color: #FFF;
            border: 2px solid #FFD700;
            padding: 15px 50px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
            transition: all 0.3s ease;
        }
        
        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.8);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #camera-preview {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 160px;
            height: 120px;
            border: 2px solid rgba(255, 0, 0, 0.5);
            transform: scaleX(-1);
            opacity: 0.7;
            border-radius: 8px;
            display: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-text {
            color: #FFD700;
            font-size: 24px;
            margin-top: 20px;
            text-shadow: 0 0 10px #FF0000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 215, 0, 0.3);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ff6b6b;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }
        
        .camera-permission {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            z-index: 300;
            max-width: 500px;
            display: none;
        }
        
        .camera-permission h3 {
            color: #FFD700;
            margin-bottom: 15px;
        }
        
        .permission-button {
            background: linear-gradient(to bottom, #D32F2F, #8B0000);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        #music-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
        }
        
        .music-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(5px);
        }
        
        .music-btn:hover {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .auto-play-note {
            position: absolute;
            top: 50px;
            left: 15px;
            color: #4CAF50;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 10px;
            z-index: 99;
        }
        
        .audio-warning {
            position: absolute;
            top: 80px;
            left: 15px;
            color: #FF9800;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 8px;
            z-index: 98;
            max-width: 200px;
        }
        
        #click-to-unmute {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 24px;
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .unmute-button {
            background: linear-gradient(to bottom, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 20px;
            cursor: pointer;
            margin-top: 30px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        
        .unmute-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.7);
        }
        
        .rotation-info {
            position: absolute;
            top: 110px;
            left: 15px;
            color: #2196F3;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 8px;
            z-index: 97;
        }
        
        /* Th√™m style cho fallback message */
        .camera-fallback {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 160px;
            height: 120px;
            border: 2px dashed rgba(255, 215, 0, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            display: none;
        }
    </style>
</head>
<body>
    <!-- M√†n h√¨nh loading -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">ƒêang t·∫£i Gi√°ng Sinh...</div>
    </div>
    
    <!-- M√†n h√¨nh y√™u c·∫ßu b·∫≠t √¢m thanh -->
    <div id="click-to-unmute">
        <h2 style="color: #FFD700; margin-bottom: 20px;">üéÑ V·ª´a l√† gi√°ng sinh c≈©ng v·ª´a l√† sinh nh·∫≠t üéÅ</h2>
        <p>Tr·∫£i nghi·ªám ƒë·∫ßy ƒë·ªß c·∫ßn √¢m thanh v√† h√¨nh ·∫£nh</p>
        <p style="font-size: 18px; margin-top: 10px;">Vui l√≤ng nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫≠t √¢m thanh</p>
        <button class="unmute-button" onclick="unmuteAudio()">
            üîà B·∫¨T √ÇM THANH & B·∫ÆT ƒê·∫¶U
        </button>
        <p style="margin-top: 20px; font-size: 14px; color: #aaa;">(Trang web n√†y s·ª≠ d·ª•ng camera ƒë·ªÉ nh·∫≠n di·ªán c·ª≠ ch·ªâ tay)</p>
    </div>
    
    <!-- Y√™u c·∫ßu camera permission -->
    <div id="camera-permission" class="camera-permission">
        <h3>üéÑ C·∫ßn truy c·∫≠p camera üéÅ</h3>
        <p>·ª®ng d·ª•ng c·∫ßn truy c·∫≠p camera ƒë·ªÉ nh·∫≠n di·ªán c·ª≠ ch·ªâ tay c·ªßa b·∫°n.</p>
        <p>Vui l√≤ng cho ph√©p s·ª≠ d·ª•ng camera ƒë·ªÉ tr·∫£i nghi·ªám t∆∞∆°ng t√°c Gi√°ng Sinh.</p>
        <button id="allow-camera" class="permission-button">CHO PH√âP S·ª¨ D·ª§NG CAMERA</button>
        <p style="margin-top: 15px; font-size: 14px; color: #aaa;">N·∫øu kh√¥ng c√≥ camera, b·∫°n v·∫´n c√≥ th·ªÉ xem hi·ªáu ·ª©ng Gi√°ng Sinh.</p>
        <button id="skip-camera" class="permission-button" style="background: #444; margin-left: 10px;">B·ªé QUA CAMERA</button>
    </div>
    
    <!-- Th√¥ng b√°o l·ªói -->
    <div id="error-message" class="error-message"></div>
    
    <!-- N√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c -->
    <div id="music-controls" style="display: none;">
        <button id="music-toggle" class="music-btn">
            <span id="music-icon">üîä</span> Nh·∫°c
        </button>
    </div>
    <div class="auto-play-note" id="auto-play-note" style="display: none;">
        Nh·∫°c ƒëang t·ª± ƒë·ªông ph√°t...
    </div>
    <div class="audio-warning" id="audio-warning" style="display: none;">
        N·∫øu kh√¥ng nghe th·∫•y nh·∫°c, h√£y click v√†o m√†n h√¨nh
    </div>
    <div class="rotation-info" id="rotation-info" style="display: none;">
        üéÅ Quay 360¬∞ b·∫±ng tay
    </div>
    
    <!-- Giao di·ªán ch√≠nh -->
    <div id="ui-layer">
        <div id="status" class="status-badge">üéÑ Sinh nh·∫≠t vui v·∫ª üéÅ</div>
        <div class="instructions">
            üñê <b>X√≤e tay:</b> Bung qu√† & ƒë√®n (xoay 360¬∞) &nbsp;|&nbsp; üëå <b>Ch·ª•m ng√≥n:</b> Xem ·∫£nh &nbsp;|&nbsp; ‚úä <b>N·∫Øm tay:</b> Thu c√¢y
        </div>
        <button id="btnStart" class="start-button" style="display: none;">TI·∫æP T·ª§C</button>
    </div>
    
    <!-- Container cho Three.js -->
    <div id="canvas-container"></div>
    
    <!-- Video v√† canvas cho camera -->
    <video id="input-video" style="display: none;"></video>
    <canvas id="camera-preview"></canvas>
    
    <!-- Fallback cho camera -->
    <div id="camera-fallback" class="camera-fallback">
        Camera kh√¥ng kh·∫£ d·ª•ng<br>
        S·ª≠ d·ª•ng ph√≠m: 1, 2, 3
    </div>
    
    <!-- Audio cho nh·∫°c n·ªÅn -->
    <audio id="bg-music" loop>
        <!-- Nh·∫°c s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ th∆∞ m·ª•c c√πng c·∫•p -->
    </audio>
    
    <script>
        // ==========================================
        // 1. C·∫§U H√åNH V√Ä KH·ªûI T·∫†O
        // ==========================================
        const CONFIG = {
            goldCount: 2000,
            redCount: 300,
            giftCount: 150,
            explodeRadius: 65,
            photoOrbitRadius: 25,
            treeHeight: 70,
            treeBaseRadius: 35,
            rotationSpeed: 0.02,
            handRotationMultiplier: 0.1
        };
        
        // C√°c bi·∫øn to√†n c·ª•c
        let scene, camera, renderer;
        let groupGold, groupRed, groupGift;
        let photoMeshes = [];
        let titleMesh, starMesh;
        
        let state = 'TREE';
        let selectedIndex = 0;
        let handX = 0.5;
        let rotationAngle = 0;
        
        let hands = null;
        let cameraActive = false;
        let musicPlaying = false;
        let audioContextStarted = false;
        let userInteracted = false;
        let cameraStream = null;

        // ==========================================
        // 2. KH·ªûI T·∫†O 3D V√Ä T·∫†O ƒê·ªêI T∆Ø·ª¢NG
        // ==========================================
        
        // T·∫°o texture t√πy ch·ªânh
        function createCustomTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const cx = 64, cy = 64;
            
            if (type === 'gold_glow') {
                const grd = ctx.createRadialGradient(cx, cy, 0, cx, cy, 40);
                grd.addColorStop(0, '#FFFFFF');
                grd.addColorStop(0.2, '#FFFFE0');
                grd.addColorStop(0.5, '#FFD700');
                grd.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grd;
                ctx.fillRect(0, 0, 128, 128);
            } else if (type === 'red_light') {
                const grd = ctx.createRadialGradient(cx, cy, 0, cx, cy, 50);
                grd.addColorStop(0, '#FFAAAA');
                grd.addColorStop(0.3, '#FF0000');
                grd.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grd;
                ctx.fillRect(0, 0, 128, 128);
            } else if (type === 'gift_red') {
                ctx.fillStyle = '#D32F2F';
                ctx.fillRect(20, 20, 88, 88);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(54, 20, 20, 88);
                ctx.fillRect(20, 54, 88, 20);
                ctx.strokeStyle = "rgba(0,0,0,0.3)";
                ctx.lineWidth = 2;
                ctx.strokeRect(20, 20, 88, 88);
            }
            
            return new THREE.CanvasTexture(canvas);
        }
        
        // T·∫°o texture
        const textures = {
            gold: createCustomTexture('gold_glow'),
            red: createCustomTexture('red_light'),
            gift: createCustomTexture('gift_red')
        };
        
        // Kh·ªüi t·∫°o scene 3D
        function init3D() {
            const container = document.getElementById('canvas-container');
            
            // T·∫°o scene
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            
            // T·∫°o camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 100;
            
            // T·∫°o renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            
            // T·∫°o h·ªá th·ªëng h·∫°t
            groupGold = createParticleSystem('gold', CONFIG.goldCount, 2.0);
            groupRed = createParticleSystem('red', CONFIG.redCount, 3.5);
            groupGift = createParticleSystem('gift', CONFIG.giftCount, 3.0);
            
            // T·∫°o ·∫£nh v√† trang tr√≠
            createPhotos();
            createDecorations();
            
            // B·∫Øt ƒë·∫ßu animation
            animate();
            
            // ·∫®n m√†n h√¨nh loading
            document.getElementById('loading').style.display = 'none';
        }
        
        // T·∫°o h·ªá th·ªëng h·∫°t
        function createParticleSystem(type, count, size) {
            const pPositions = [];
            const pExplodeTargets = [];
            const pTreeTargets = [];
            
            for (let i = 0; i < count; i++) {
                // V·ªã tr√≠ tr√™n c√¢y th√¥ng
                const h = Math.random() * CONFIG.treeHeight;
                const y = h - CONFIG.treeHeight / 2;
                
                let radiusRatio = (type === 'gold') ? Math.sqrt(Math.random()) : 0.9 + Math.random() * 0.1;
                const maxR = (1 - (h / CONFIG.treeHeight)) * CONFIG.treeBaseRadius;
                const r = maxR * radiusRatio;
                const theta = Math.random() * Math.PI * 2;
                
                const tx = r * Math.cos(theta);
                const tz = r * Math.sin(theta);
                pTreeTargets.push(tx, y, tz);
                
                // V·ªã tr√≠ khi bung ra
                const u = Math.random();
                const v = Math.random();
                const phi = Math.acos(2 * v - 1);
                const lam = 2 * Math.PI * u;
                
                let radMult = (type === 'gift') ? 1.2 : 1.0;
                const rad = CONFIG.explodeRadius * Math.cbrt(Math.random()) * radMult;
                
                const ex = rad * Math.sin(phi) * Math.cos(lam);
                const ey = rad * Math.sin(phi) * Math.sin(lam);
                const ez = rad * Math.cos(phi);
                pExplodeTargets.push(ex, ey, ez);
                
                // V·ªã tr√≠ ban ƒë·∫ßu
                pPositions.push(tx, y, tz);
            }
            
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pPositions, 3));
            geo.userData = { tree: pTreeTargets, explode: pExplodeTargets };
            
            const mat = new THREE.PointsMaterial({
                size: size,
                map: textures[type],
                transparent: true,
                opacity: 1.0,
                blending: (type === 'gift') ? THREE.NormalBlending : THREE.AdditiveBlending,
                depthWrite: false,
                sizeAttenuation: true
            });
            
            const points = new THREE.Points(geo, mat);
            scene.add(points);
            return points;
        }
        
        // T·∫°o c√°c ·∫£nh
        function createPhotos() {
            const photoUrls = [
                'https://i.postimg.cc/kGt0Zbrg/image1.jpg',
                'https://i.postimg.cc/q7w6hNZS/image2.jpg',
                'https://i.postimg.cc/0QrjzcS0/image3.jpg',
                'https://i.postimg.cc/1R2MMz91/image4.jpg',
                'https://i.postimg.cc/RhH72cM9/image5.jpg'
            ];
            
            const loader = new THREE.TextureLoader();
            const geo = new THREE.PlaneGeometry(8, 8);
            const borderGeo = new THREE.PlaneGeometry(9, 9);
            const borderMat = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
            
            for (let i = 0; i < 5; i++) {
                const texture = loader.load(photoUrls[i], undefined, undefined, 
                    function(err) {
                        console.error('Kh√¥ng th·ªÉ t·∫£i ·∫£nh:', photoUrls[i], err);
                    });
                
                const mat = new THREE.MeshBasicMaterial({
                    map: texture,
                    side: THREE.DoubleSide
                });
                
                const mesh = new THREE.Mesh(geo, mat);
                const border = new THREE.Mesh(borderGeo, borderMat);
                border.position.z = -0.1;
                mesh.add(border);
                
                mesh.visible = false;
                mesh.scale.set(0, 0, 0);
                scene.add(mesh);
                photoMeshes.push(mesh);
            }
        }
        
        // T·∫°o trang tr√≠
        function createDecorations() {
            // T·∫°o ti√™u ƒë·ªÅ
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.font = 'bold 70px "Times New Roman"';
            ctx.fillStyle = '#FFD700';
            ctx.textAlign = 'center';
            ctx.shadowColor = "#FF0000";
            ctx.shadowBlur = 40;
            ctx.fillText("Ch√∫c M·ª´ng Sinh Nh·∫≠t H∆∞ng", 512, 130);
            
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.MeshBasicMaterial({
                map: tex,
                transparent: true,
                blending: THREE.AdditiveBlending
            });
            titleMesh = new THREE.Mesh(new THREE.PlaneGeometry(60, 15), mat);
            titleMesh.position.set(0, 50, 0);
            scene.add(titleMesh);
            
            // T·∫°o ng√¥i sao
            const starCanvas = document.createElement('canvas');
            starCanvas.width = 128;
            starCanvas.height = 128;
            const sCtx = starCanvas.getContext('2d');
            sCtx.fillStyle = "#FFFF00";
            sCtx.shadowColor = "#FFF";
            sCtx.shadowBlur = 20;
            
            sCtx.beginPath();
            const cx = 64, cy = 64, outer = 50, inner = 20;
            for (let i = 0; i < 5; i++) {
                sCtx.lineTo(
                    cx + Math.cos((18 + i * 72) / 180 * Math.PI) * outer,
                    cy - Math.sin((18 + i * 72) / 180 * Math.PI) * outer
                );
                sCtx.lineTo(
                    cx + Math.cos((54 + i * 72) / 180 * Math.PI) * inner,
                    cy - Math.sin((54 + i * 72) / 180 * Math.PI) * inner
                );
            }
            sCtx.closePath();
            sCtx.fill();
            
            const starTex = new THREE.CanvasTexture(starCanvas);
            const starMat = new THREE.MeshBasicMaterial({
                map: starTex,
                transparent: true,
                blending: THREE.AdditiveBlending
            });
            starMesh = new THREE.Mesh(new THREE.PlaneGeometry(12, 12), starMat);
            starMesh.position.set(0, CONFIG.treeHeight / 2 + 2, 0);
            scene.add(starMesh);
        }
        
        // C·∫≠p nh·∫≠t h·ªá th·ªëng h·∫°t
        function updateParticleGroup(group, targetState, speed, handRotY, time, isBlinking) {
            const positions = group.geometry.attributes.position.array;
            const targetKey = (targetState === 'TREE') ? 'tree' : 'explode';
            const targets = group.geometry.userData[(targetState === 'PHOTO') ? 'explode' : targetKey];
            
            for (let i = 0; i < positions.length; i++) {
                positions[i] += (targets[i] - positions[i]) * speed;
            }
            group.geometry.attributes.position.needsUpdate = true;
            
            if (targetState === 'TREE') {
                // C√¢y th√¥ng xoay ch·∫≠m
                group.rotation.y += 0.003;
                if (isBlinking) {
                    const scale = 1 + Math.sin(time * 5) * 0.2;
                    group.scale.set(scale, scale, scale);
                } else {
                    group.scale.set(1, 1, 1);
                }
            } else {
                // Khi bung qu√†: XOAY 360¬∞ LI√äN T·ª§C
                group.scale.set(1, 1, 1);
                
                // C√ÅCH 2: Xoay theo c·ª≠ ch·ªâ tay (t·ª´ -180¬∞ ƒë·∫øn +180¬∞)
                // Chuy·ªÉn ƒë·ªïi handX (0-1) th√†nh g√≥c (-œÄ ƒë·∫øn +œÄ)
                const targetRotation = (handX - 0.5) * Math.PI * 2;
                
                // √Åp d·ª•ng xoay m∆∞·ª£t m√†
                group.rotation.y += (targetRotation - group.rotation.y) * 0.05;
                
                // C·∫≠p nh·∫≠t g√≥c xoay t·ªïng
                rotationAngle = group.rotation.y;
            }
        }
        
        // V√≤ng l·∫∑p animation
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            const speed = 0.06;
            
            // T√≠nh g√≥c xoay t·ª´ v·ªã tr√≠ tay
            const handRotY = (handX - 0.5) * Math.PI * 2; // -œÄ ƒë·∫øn +œÄ
            
            updateParticleGroup(groupGold, state, speed, handRotY, time, false);
            updateParticleGroup(groupRed, state, speed, handRotY, time, true);
            updateParticleGroup(groupGift, state, speed, handRotY, time, false);
            
            if (state === 'TREE') {
                titleMesh.visible = true;
                starMesh.visible = true;
                titleMesh.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
                starMesh.rotation.z -= 0.02;
                photoMeshes.forEach(m => {
                    m.scale.lerp(new THREE.Vector3(0, 0, 0), 0.1);
                    m.visible = false;
                });
                
                // ·∫®n th√¥ng tin xoay khi ·ªü ch·∫ø ƒë·ªô c√¢y
                document.getElementById('rotation-info').style.display = 'none';
                
            } else if (state === 'EXPLODE') {
                titleMesh.visible = false;
                starMesh.visible = false;
                
                // HI·ªÇN TH·ªä th√¥ng tin xoay khi bung qu√†
                document.getElementById('rotation-info').style.display = 'block';
                
                // S·ª≠ d·ª•ng g√≥c xoay th·ª±c t·∫ø c·ªßa groupGold (c√≥ th·ªÉ > 2œÄ)
                const currentRotation = groupGold.rotation.y;
                const angleStep = (Math.PI * 2) / 5;
                let bestIdx = 0;
                let maxZ = -999;
                
                photoMeshes.forEach((mesh, i) => {
                    mesh.visible = true;
                    
                    // T√≠nh g√≥c v·ªõi xoay li√™n t·ª•c
                    const angle = currentRotation + i * angleStep;
                    const x = Math.sin(angle) * CONFIG.photoOrbitRadius;
                    const z = Math.cos(angle) * CONFIG.photoOrbitRadius;
                    const y = Math.sin(time + i) * 3;
                    
                    mesh.position.lerp(new THREE.Vector3(x, y, z), 0.1);
                    mesh.lookAt(camera.position);
                    
                    // T√¨m ·∫£nh g·∫ßn camera nh·∫•t (z l·ªõn nh·∫•t)
                    if (z > maxZ) {
                        maxZ = z;
                        bestIdx = i;
                    }
                    
                    // Scale ·∫£nh theo kho·∫£ng c√°ch
                    if (z > 5) {
                        const distScale = 1.0 + (z / CONFIG.photoOrbitRadius) * 0.8;
                        mesh.scale.lerp(new THREE.Vector3(distScale, distScale, distScale), 0.1);
                    } else {
                        mesh.scale.lerp(new THREE.Vector3(0.6, 0.6, 0.6), 0.1);
                    }
                });
                selectedIndex = bestIdx;
                
                // C·∫≠p nh·∫≠t th√¥ng tin xoay
                const degrees = Math.round((currentRotation * 180 / Math.PI) % 360);
                document.getElementById('rotation-info').innerHTML = 
                    `üéÅ Xoay: ${degrees}¬∞ (di chuy·ªÉn tay tr√°i/ph·∫£i)`;
                    
            } else if (state === 'PHOTO') {
                photoMeshes.forEach((mesh, i) => {
                    if (i === selectedIndex) {
                        mesh.position.lerp(new THREE.Vector3(0, 0, 60), 0.1);
                        mesh.scale.lerp(new THREE.Vector3(5, 5, 5), 0.1);
                        mesh.lookAt(camera.position);
                        mesh.rotation.z = 0;
                    } else {
                        mesh.scale.lerp(new THREE.Vector3(0, 0, 0), 0.1);
                    }
                });
                
                // ·∫®n th√¥ng tin xoay khi xem ·∫£nh
                document.getElementById('rotation-info').style.display = 'none';
            }
            
            renderer.render(scene, camera);
        }
        
        // ==========================================
        // 3. X·ª¨ L√ù √ÇM THANH V√Ä KH·ªûI ƒê·ªòNG
        // ==========================================
        
        // H√†m ch√≠nh ƒë·ªÉ b·∫≠t √¢m thanh v√† b·∫Øt ƒë·∫ßu
        function unmuteAudio() {
            console.log("Ng∆∞·ªùi d√πng ƒë√£ click ƒë·ªÉ b·∫≠t √¢m thanh");
            userInteracted = true;
            
            // ·∫®n m√†n h√¨nh y√™u c·∫ßu b·∫≠t √¢m thanh
            document.getElementById('click-to-unmute').style.display = 'none';
            
            // Kh·ªüi t·∫°o nh·∫°c n·ªÅn
            initBackgroundMusic();
            
            // Hi·ªÉn th·ªã n√∫t "TI·∫æP T·ª§C"
            document.getElementById('btnStart').style.display = 'inline-block';
            
            // Hi·ªÉn th·ªã th√¥ng b√°o
            document.getElementById('status').innerHTML = "üéÑ Nh·∫•n 'TI·∫æP T·ª§C' ƒë·ªÉ b·∫Øt ƒë·∫ßu üéÅ";
        }
        
        // Kh·ªüi t·∫°o nh·∫°c n·ªÅn
        function initBackgroundMusic() {
            const bgMusic = document.getElementById('bg-music');
            
            // ƒê·∫∑t ngu·ªìn nh·∫°c t·ª´ file audio.mp3 trong c√πng th∆∞ m·ª•c
            bgMusic.src = 'audio.mp3';
            bgMusic.volume = 0.4; // √Çm l∆∞·ª£ng v·ª´a ph·∫£i
            bgMusic.loop = true;
            bgMusic.preload = 'auto';
            
            console.log("ƒê√£ kh·ªüi t·∫°o nh·∫°c n·ªÅn t·ª´ file audio.mp3");
            
            // Th·ª≠ ph√°t nh·∫°c ngay l·∫≠p t·ª©c v√¨ ng∆∞·ªùi d√πng ƒë√£ t∆∞∆°ng t√°c
            playBackgroundMusic();
        }
        
        // Ph√°t nh·∫°c n·ªÅn
        function playBackgroundMusic() {
            const bgMusic = document.getElementById('bg-music');
            
            if (userInteracted) {
                const playPromise = bgMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Th√†nh c√¥ng
                        musicPlaying = true;
                        console.log("‚úÖ Nh·∫°c Gi√°ng sinh ƒëang ph√°t!");
                        
                        // C·∫≠p nh·∫≠t UI
                        document.getElementById('music-controls').style.display = 'block';
                        document.getElementById('auto-play-note').style.display = 'block';
                        document.getElementById('auto-play-note').innerHTML = "üîä Nh·∫°c ƒëang ph√°t...";
                        document.getElementById('music-icon').textContent = "üîä";
                        
                        // ·∫®n c·∫£nh b√°o
                        document.getElementById('audio-warning').style.display = 'none';
                        
                    }).catch(error => {
                        // Th·∫•t b·∫°i
                        console.log("‚ùå L·ªói khi ph√°t nh·∫°c:", error);
                        
                        // Hi·ªÉn th·ªã c·∫£nh b√°o v√† h∆∞·ªõng d·∫´n
                        document.getElementById('audio-warning').style.display = 'block';
                        document.getElementById('audio-warning').innerHTML = "Nh·∫•n v√†o m√†n h√¨nh ƒë·ªÉ th·ª≠ l·∫°i";
                        
                        // Th√™m s·ª± ki·ªán click ƒë·ªÉ th·ª≠ ph√°t nh·∫°c
                        const retryAudioOnClick = () => {
                            bgMusic.play().then(() => {
                                musicPlaying = true;
                                console.log("‚úÖ Nh·∫°c ƒë√£ ƒë∆∞·ª£c b·∫≠t sau khi click!");
                                document.getElementById('audio-warning').style.display = 'none';
                            });
                        };
                        document.addEventListener('click', retryAudioOnClick);
                    });
                }
            }
        }
        
        // H√†m b·∫Øt ƒë·∫ßu h·ªá th·ªëng ch√≠nh
        function startSystem() {
            const btnStart = document.getElementById('btnStart');
            btnStart.style.display = 'none';
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i
            document.getElementById('status').innerHTML = "üéÑ Sinh nh·∫≠t vui v·∫ª (Xoay tay ƒë·ªÉ xem qu√†) üéÅ";
            
            // Kh·ªüi t·∫°o 3D
            init3D();
            
            // Y√™u c·∫ßu camera
            requestCameraPermission();
        }
        
        // ==========================================
        // 4. T∆Ø∆†NG T√ÅC B√ÄN TAY V√Ä CAMERA - ƒê√É S·ª¨A L·ªñI GITHUB
        // ==========================================
        
        // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p camera
        function requestCameraPermission() {
            const permissionDiv = document.getElementById('camera-permission');
            permissionDiv.style.display = 'block';
            
            document.getElementById('allow-camera').addEventListener('click', async function() {
                try {
                    const constraints = { 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: "user"
                        } 
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraStream = stream;
                    
                    permissionDiv.style.display = 'none';
                    initHandTracking(stream);
                    
                } catch (err) {
                    console.error("L·ªói truy c·∫≠p camera:", err);
                    showError("Kh√¥ng th·ªÉ truy c·∫≠p camera: " + err.message);
                    permissionDiv.style.display = 'none';
                    
                    // Hi·ªÉn th·ªã fallback v√† h∆∞·ªõng d·∫´n ph√≠m t·∫Øt
                    document.getElementById('camera-fallback').style.display = 'flex';
                    document.getElementById('status').innerText = "üéÑ Sinh nh·∫≠t vui v·∫ª (D√πng ph√≠m: 1, 2, 3) üéÅ";
                    document.getElementById('rotation-info').innerText = "üéÅ Xoay qu√† b·∫±ng ph√≠m ‚Üê ‚Üí";
                    
                    // Th√™m h∆∞·ªõng d·∫´n ph√≠m t·∫Øt v√†o instructions
                    document.querySelector('.instructions').innerHTML += 
                        " &nbsp;|&nbsp; üéÆ <b>Ph√≠m:</b> 1=C√¢y, 2=Qu√†, 3=·∫¢nh";
                }
            });
            
            document.getElementById('skip-camera').addEventListener('click', function() {
                permissionDiv.style.display = 'none';
                document.getElementById('status').innerText = "üéÑ Sinh nh·∫≠t vui v·∫ª (D√πng ph√≠m: 1, 2, 3) üéÅ";
                
                // Hi·ªÉn th·ªã fallback v√† h∆∞·ªõng d·∫´n ph√≠m t·∫Øt
                document.getElementById('camera-fallback').style.display = 'flex';
                document.getElementById('rotation-info').innerText = "üéÅ Xoay qu√† b·∫±ng ph√≠m ‚Üê ‚Üí";
                
                // Th√™m h∆∞·ªõng d·∫´n ph√≠m t·∫Øt v√†o instructions
                document.querySelector('.instructions').innerHTML += 
                    " &nbsp;|&nbsp; üéÆ <b>Ph√≠m:</b> 1=C√¢y, 2=Qu√†, 3=·∫¢nh";
            });
        }
        
        // Kh·ªüi t·∫°o nh·∫≠n di·ªán tay - PHI√äN B·∫¢N D·ª∞ PH√íNG CHO GITHUB
        function initHandTracking(stream) {
            const video = document.getElementById('input-video');
            const canvas = document.getElementById('camera-preview');
            const ctx = canvas.getContext('2d');
            const statusDiv = document.getElementById('status');
            
            // ·∫®n fallback n·∫øu camera ho·∫°t ƒë·ªông
            document.getElementById('camera-fallback').style.display = 'none';
            
            canvas.style.display = 'block';
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play().catch(e => {
                    console.log("Video play b·ªã t·ª´ ch·ªëi:", e);
                    showError("Kh√¥ng th·ªÉ ph√°t video t·ª´ camera");
                });
            };
            
            // Ki·ªÉm tra xem MediaPipe c√≥ t·∫£i th√†nh c√¥ng kh√¥ng
            if (typeof Hands === 'undefined') {
                console.error("MediaPipe Hands kh√¥ng t·∫£i ƒë∆∞·ª£c!");
                showError("Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán nh·∫≠n di·ªán tay. S·ª≠ d·ª•ng ph√≠m t·∫Øt thay th·∫ø.");
                return;
            }
            
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // Gi·∫£m ƒë·ªô ph·ª©c t·∫°p ƒë·ªÉ tƒÉng hi·ªáu su·∫•t
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults((results) => {
                if (!results || !results.image) return;
                
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
                    
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        const landmarks = results.multiHandLandmarks[0];
                        
                        // L·∫•y v·ªã tr√≠ ng√≥n tr·ªè
                        handX = landmarks[8].x;
                        
                        const tips = [8, 12, 16, 20];
                        const wrist = landmarks[0];
                        
                        let totalDistance = 0;
                        tips.forEach(index => {
                            const tip = landmarks[index];
                            totalDistance += Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
                        });
                        const avgFingerDistance = totalDistance / 4;
                        
                        const thumbTip = landmarks[4];
                        const indexTip = landmarks[8];
                        const pinchDistance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                        
                        if (avgFingerDistance < 0.25) {
                            state = 'TREE';
                            statusDiv.innerText = "‚úä Thu C√¢y Th√¥ng";
                            statusDiv.style.color = "#FFD700";
                        } else if (pinchDistance < 0.08) {
                            state = 'PHOTO';
                            statusDiv.innerText = "üëå Xem ·∫¢nh";
                            statusDiv.style.color = "#00FFFF";
                        } else {
                            state = 'EXPLODE';
                            statusDiv.innerText = "üñê Bung Qu√† & Xoay 360¬∞";
                            statusDiv.style.color = "#FFA500";
                        }
                        
                        cameraActive = true;
                    } else {
                        state = 'TREE';
                        statusDiv.innerText = "üéÑ ƒê∆∞a tay v√†o khung h√¨nh üéÅ";
                        statusDiv.style.color = "#FFF";
                    }
                } catch (err) {
                    console.error("L·ªói x·ª≠ l√Ω k·∫øt qu·∫£ MediaPipe:", err);
                }
            });
            
            // S·ª≠ d·ª•ng requestAnimationFrame thay v√¨ Camera class
            function processFrame() {
                if (video.readyState >= 2 && hands) {
                    try {
                        hands.send({image: video});
                    } catch (err) {
                        console.error("L·ªói send MediaPipe:", err);
                    }
                }
                requestAnimationFrame(processFrame);
            }
            
            processFrame();
        }
        
        // H√†m ƒëi·ªÅu khi·ªÉn nh·∫°c
        function toggleMusic() {
            const bgMusic = document.getElementById('bg-music');
            const icon = document.getElementById('music-icon');
            const note = document.getElementById('auto-play-note');
            
            if (bgMusic.paused) {
                bgMusic.play();
                icon.textContent = "üîä";
                note.innerHTML = "üîä Nh·∫°c ƒëang ph√°t...";
                console.log("Nh·∫°c ti·∫øp t·ª•c ph√°t");
            } else {
                bgMusic.pause();
                icon.textContent = "üîá";
                note.innerHTML = "‚è∏Ô∏è Nh·∫°c ƒë√£ t·∫°m d·ª´ng";
                console.log("Nh·∫°c ƒë√£ t·∫°m d·ª´ng");
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = "L·ªói: " + message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Ki·ªÉm tra l·ªói t·∫£i nh·∫°c
        function checkMusicError() {
            const bgMusic = document.getElementById('bg-music');
            
            bgMusic.addEventListener('error', function(e) {
                console.error("‚ùå L·ªói t·∫£i file nh·∫°c:", e);
                showError("Kh√¥ng th·ªÉ t·∫£i file audio.mp3. ƒê·∫£m b·∫£o file t·ªìn t·∫°i trong th∆∞ m·ª•c c√πng c·∫•p v·ªõi file HTML.");
                document.getElementById('auto-play-note').innerHTML = "‚ùå L·ªói t·∫£i nh·∫°c";
                document.getElementById('auto-play-note').style.color = "#ff6b6b";
            });
            
            bgMusic.addEventListener('loadeddata', function() {
                console.log("‚úÖ File nh·∫°c ƒë√£ t·∫£i th√†nh c√¥ng");
            });
        }
        
        // D·ªçn d·∫πp camera stream khi trang ƒë√≥ng
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
        
        // ==========================================
        // 5. KH·ªûI T·∫†O S·ª∞ KI·ªÜN
        // ==========================================
        
        // G√°n s·ª± ki·ªán cho n√∫t B·∫ÆT ƒê·∫¶U/TI·∫æP T·ª§C
        document.getElementById('btnStart').addEventListener('click', startSystem);
        
        // G√°n s·ª± ki·ªán cho n√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c
        document.getElementById('music-toggle').addEventListener('click', toggleMusic);
        
        // Ki·ªÉm tra l·ªói nh·∫°c khi t·∫£i trang
        checkMusicError();
        
        // X·ª≠ l√Ω resize window
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // X·ª≠ l√Ω ph√≠m t·∫Øt - TH√äM ƒêI·ªÄU KHI·ªÇN XOAY
        document.addEventListener('keydown', (e) => {
            if (e.key === '1' || e.key === ' ') {
                state = 'TREE';
                document.getElementById('status').innerText = "üéÑ Sinh nh·∫≠t vui v·∫ª (Ph√≠m: 1, 2, 3) üéÅ";
                document.getElementById('status').style.color = "#FFD700";
            } else if (e.key === '2') {
                state = 'EXPLODE';
                document.getElementById('status').innerText = "‚ú® Bung Qu√† & Xoay 360¬∞ ‚ú®";
                document.getElementById('status').style.color = "#FFA500";
                
                // Reset g√≥c xoay khi chuy·ªÉn sang ch·∫ø ƒë·ªô bung qu√†
                rotationAngle = 0;
                if (groupGold) groupGold.rotation.y = 0;
                if (groupRed) groupRed.rotation.y = 0;
                if (groupGift) groupGift.rotation.y = 0;
                
                // Hi·ªÉn th·ªã th√¥ng tin xoay
                document.getElementById('rotation-info').style.display = 'block';
                document.getElementById('rotation-info').innerText = "üéÅ Xoay qu√† b·∫±ng ph√≠m ‚Üê ‚Üí";
                
            } else if (e.key === '3') {
                state = 'PHOTO';
                document.getElementById('status').innerText = "üì∏ Xem ·∫¢nh üì∏";
                document.getElementById('status').style.color = "#00FFFF";
            } else if (e.key === 'm' || e.key === 'M') {
                toggleMusic(); // Ph√≠m M ƒë·ªÉ b·∫≠t/t·∫Øt nh·∫°c
            } else if (e.key === 'ArrowLeft') {
                // Ph√≠m m≈©i t√™n tr√°i: xoay tr√°i
                if (state === 'EXPLODE') {
                    if (groupGold) groupGold.rotation.y -= 0.1;
                    if (groupRed) groupRed.rotation.y -= 0.1;
                    if (groupGift) groupGift.rotation.y -= 0.1;
                }
            } else if (e.key === 'ArrowRight') {
                // Ph√≠m m≈©i t√™n ph·∫£i: xoay ph·∫£i
                if (state === 'EXPLODE') {
                    if (groupGold) groupGold.rotation.y += 0.1;
                    if (groupRed) groupRed.rotation.y += 0.1;
                    if (groupGift) groupGift.rotation.y += 0.1;
                }
            }
        });
        
        // Hi·ªÉn th·ªã m√†n h√¨nh b·∫≠t √¢m thanh khi t·∫£i trang
        window.addEventListener('load', () => {
            // ·∫®n m√†n h√¨nh loading sau 1 gi√¢y
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                // Hi·ªÉn th·ªã m√†n h√¨nh y√™u c·∫ßu b·∫≠t √¢m thanh
                document.getElementById('click-to-unmute').style.display = 'flex';
                
                console.log("Trang ƒë√£ t·∫£i xong.");
                console.log("üìÇ ƒê·∫£m b·∫£o file 'audio.mp3' n·∫±m c√πng th∆∞ m·ª•c v·ªõi file HTML n√†y");
                console.log("üîÑ ·ª®ng d·ª•ng ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u cho GitHub Pages");
                console.log("üéÆ C√≥ th·ªÉ s·ª≠ d·ª•ng ph√≠m t·∫Øt n·∫øu camera kh√¥ng ho·∫°t ƒë·ªông");
            }, 1000);
        });
        
        // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n ph√≠m t·∫Øt
        console.log("H∆∞·ªõng d·∫´n ph√≠m t·∫Øt:");
        console.log("1 ho·∫∑c Space: C√¢y th√¥ng");
        console.log("2: Bung qu√† v√† ·∫£nh (xoay 360¬∞)");
        console.log("3: Xem ·∫£nh ph√≥ng to");
        console.log("M: B·∫≠t/t·∫Øt nh·∫°c");
        console.log("‚Üê ‚Üí : Xoay qu√† (khi ·ªü ch·∫ø ƒë·ªô bung qu√†)");
    </script>
</body>
</html>